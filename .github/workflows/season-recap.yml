name: Season Recap Report

on:
  # Manual triggering only (run after season completes)
  workflow_dispatch:
    inputs:
      season_year:
        description: 'Season year (default: current year)'
        required: false
        type: number
      email_recipients:
        description: 'Email recipients (comma-separated, leave empty to use default from secrets)'
        required: false
        type: string
      email_from:
        description: 'Email sender (leave empty to use default from secrets)'
        required: false
        type: string
      skip_email:
        description: 'Skip sending email (useful for testing report generation only)'
        required: false
        type: boolean
        default: false
      recap_note:
        description: 'Optional note for season recap (e.g., "Thanks for a great season!")'
        required: false
        type: string
      force_generation:
        description: 'Force generation even if season incomplete (for testing)'
        required: false
        type: boolean
        default: false

env:
  PYTHONUNBUFFERED: 1

jobs:
  generate-season-recap:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Install dependencies
      run: uv sync

    - name: Create .env file from secrets
      run: |
        echo "LEAGUE_IDS=${{ secrets.LEAGUE_IDS }}" > .env
        if [ -n "${{ secrets.ESPN_SWID }}" ]; then
          echo "ESPN_SWID=${{ secrets.ESPN_SWID }}" >> .env
        fi
        if [ -n "${{ secrets.ESPN_S2 }}" ]; then
          echo "ESPN_S2=${{ secrets.ESPN_S2 }}" >> .env
        fi

    - name: Generate season recap report
      id: generate-report
      run: |
        # Hardcoded note for season recap (set to empty string to disable)
        # Example: HARDCODED_NOTE="Thanks for an amazing season! See you next year! üèÜ"
        HARDCODED_NOTE=""

        # Determine if private leagues are needed
        if [ -n "${{ secrets.ESPN_SWID }}" ] && [ -n "${{ secrets.ESPN_S2 }}" ]; then
          PRIVATE_FLAG="--private"
        else
          PRIVATE_FLAG=""
        fi

        # Add year override if provided
        if [ -n "${{ inputs.season_year }}" ]; then
          YEAR_FLAG="--year ${{ inputs.season_year }}"
          echo "Using year override: ${{ inputs.season_year }}"
          SEASON_YEAR="${{ inputs.season_year }}"
        else
          YEAR_FLAG=""
          SEASON_YEAR=$(date +%Y)
          echo "Using current year: $SEASON_YEAR"
        fi

        # Add force flag if requested
        if [ "${{ inputs.force_generation }}" = "true" ]; then
          FORCE_FLAG="--force"
          echo "Force generation enabled (season may be incomplete)"
        else
          FORCE_FLAG=""
        fi

        # Build format args - workflow input takes precedence over hardcoded note
        if [ -n "${{ inputs.recap_note }}" ]; then
          FORMAT_ARGS=(--format-arg "note=${{ inputs.recap_note }}")
        elif [ -n "$HARDCODED_NOTE" ]; then
          FORMAT_ARGS=(--format-arg "note=$HARDCODED_NOTE")
        else
          FORMAT_ARGS=()
        fi

        # Capture start time
        START_TIME=$(date +%s)

        # Generate all output formats in one execution using --output-dir
        mkdir -p ./reports
        uv run ff-season-recap --env $PRIVATE_FLAG $YEAR_FLAG $FORCE_FLAG --output-dir ./reports "${FORMAT_ARGS[@]}"

        # Calculate execution time
        END_TIME=$(date +%s)
        EXECUTION_TIME=$((END_TIME - START_TIME))

        echo "season_year=${SEASON_YEAR}" >> $GITHUB_OUTPUT
        echo "execution_time=${EXECUTION_TIME}" >> $GITHUB_OUTPUT
        echo "report_generated=true" >> $GITHUB_OUTPUT

    # Read HTML report content for email body
    - name: Prepare email content
      id: prepare-email
      if: steps.generate-report.outputs.report_generated == 'true'
      run: |
        # Inject metadata into HTML report
        GENERATED_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        EXECUTION_TIME="${{ steps.generate-report.outputs.execution_time }}"
        RUN_ID="${{ github.run_id }}"
        REPO="${{ github.repository }}"

        # Create metadata HTML
        METADATA_HTML="Generated: ${GENERATED_TIME} (took ${EXECUTION_TIME}s)<br>"
        METADATA_HTML+="<a href=\"https://github.com/${REPO}/actions/runs/${RUN_ID}\" style=\"color: #3498db; text-decoration: none;\">Download Full Report Artifacts üì¶</a><br>"

        # Inject metadata between comment markers using sed
        sed -i "s|<!-- GENERATED_METADATA_START --><!-- GENERATED_METADATA_END -->|<!-- GENERATED_METADATA_START -->${METADATA_HTML}<!-- GENERATED_METADATA_END -->|g" ./reports/season-recap.html

        # Verify the file exists and was modified
        if [ -f ./reports/season-recap.html ]; then
          echo "html_ready=true" >> $GITHUB_OUTPUT
          echo "Successfully injected metadata into HTML report"
        else
          echo "html_ready=false" >> $GITHUB_OUTPUT
          echo "Error: HTML file not found" >&2
          exit 1
        fi

    - name: Send email report
      if: steps.generate-report.outputs.report_generated == 'true' && inputs.skip_email != true
      uses: dawidd6/action-send-mail@v6
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT || '2525' }}
        secure: ${{ secrets.SMTP_SECURE || 'false' }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "üèÜ Season Recap - ${{ steps.generate-report.outputs.season_year }} Season"
        from: "MM Fantasy Football League <${{ inputs.email_from || secrets.EMAIL_FROM }}>"
        to: ${{ inputs.email_from || secrets.EMAIL_FROM }}
        bcc: ${{ inputs.email_recipients || secrets.EMAIL_RECIPIENTS }}
        html_body: file://./reports/season-recap.html

    - name: Upload report artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: season-recap-${{ steps.generate-report.outputs.season_year }}
        path: |
          ./reports/season-recap.txt
          ./reports/season-recap.tsv
          ./reports/season-recap.html
          ./reports/season-recap.json
          ./reports/season-recap.md
        retention-days: 365
